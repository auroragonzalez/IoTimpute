function [zk,vk]=krigingfilter(ck,ch,zh,model,param,nhmax,dmax,order,filtmean,filtmodel,options);% krigingfilter             - prediction using kriging methods with filtering (Jan 1,2001)%% Do basically the same computations than the kriging.m function, but% the user has the possibility of specifying which model components% have to be estimated and which one have to be filtered out from the% estimation. Filtering the components with kriging is a possibility% that is offered by the linear properties of the algorithm. Both the% mean and the model components can be the object of the filtering.% Each component can be estimated separately and orthogonally from the% others. The sum of separetely estimated components corresponds% to the estimated values yielded by kriging.m.%% SYNTAX :%% [zk,vk]=krigingfilter(ck,ch,zh,model,param,nhmax,dmax,order,filtmean,filtmodel,options);%% INPUT :%% ck        nk by d   matrix of coordinates for the estimation locations.%                     A line corresponds to the vector of coordinates at%                     an estimation location, so the number of columns%                     corresponds to the dimension of the space. There is%                     no restriction on the dimension of the space.% ch        nh by d   matrix of coordinates for the hard data locations,%                     with the same convention as for ck.% zh        nh by 1   vector of values for the hard data at the coordinates%                     specified in ch.% model     string    that contains the name of the variogram or covariance%                     model that is used for the estimation (see the MODELS%                     directory). % param     1 by k    vector of values for the parameters of model, according%                     to the convention for the corresponding variogram or %                     covariance model.% nhmax     scalar    maximum number of hard data values that are considered%                     for the estimation at each location.% dmax      scalar    maximum distance between an estimation location and%                     existing hard data locations. All hard data locations%                     separated by a distance smaller than dmax from an%                     estimation location will be included in the estimation%                     process for that location, whereas other hard data%                     locations are neglected.% order     scalar    order of the polynomial mean along the spatial axes at%                     the estimation locations. For the zero-mean case, NaN%                     (Not-a-Number) is used. Note that order=NaN can only be%                     used with covariance models and not with variogram models.% filtmean  scalar    value specifying if the mean is to be estimated (filtmean=1)%                     or is to be filtered out (filtmean=0).% filtmodel scalar    value specifying if the stochastic model component is to be%                     estimated (filtmodel=1) or is to be filtered out (filtmodel=0).%                     If the variogram or covariance model is nested, filtmodel is%                     a 1 by m vector that has as many elements (with values equal%                     to 1 or 0) as there are elements in the model cell array.% options   scalar    optional parameter that can be used if the default value%                     is not satisfactory (otherwise it can simply be omitted%                     from the input list of variables). options(1) is taking%                     the value 1 or 0 depending if the user wants or does not%                     want to display the order number of the location which is%                     currently processed, respectively.%% OUTPUT :%% zk        nk by 1   vector of the estimated values for the non filtered out mean%                     and/or model components at the estimation locations ck. A value%                     coded as NaN means that no estimation has been performed at%                     that location due to the lack of available data.% vk        nk by 1   vector of estimation (kriging) variances for the estimated%                     mean and/or model components at the estimation locations, with%                     same conventions as for zk.%% NOTE :%% All the specific conventions for specifying nested models, multivariate% or space-time cases are the same as for kriging.m.%%%%%% Initialize the parametersif nargin<9,  options(1)=0;end;noindex=~iscell(ck);       % test if there is an index for the variablesif noindex==1,  nk=size(ck,1);           % nk is the number of estimation pointselse  nk=size(ck{1},1);  nindexk=length(ck{2});  if nindexk==1,    ck{2}=ck{2}*ones(nk,1);  end;end;if options(1)==1,  num2strnk=num2str(nk);end;zk=zeros(nk,1)*NaN;vk=zeros(nk,1)*NaN;K0=NaN;%%%%%% Main loop starts herefor i=1:nk,  if noindex==1,    ck0=ck(i,:);  else    ck0={ck{1}(i,:),ck{2}(i)};  end;  [chlocal,zhlocal,dh,sumnhlocal]=neighbours(ck0,ch,zh,nhmax,dmax);  if sumnhlocal>0,                               % test if there is at least 1 data     K=coord2K(chlocal,chlocal,model,param);      % built the left-hand side matrix    k=coord2K(chlocal,ck0,model,param,filtmodel);% built the right-hand side vector    [X,x]=krigconstr(chlocal,ck0,order);    nx=size(X,2);    Kadd=[[K,X];[X',zeros(nx)]];    if filtmean==1,      kadd=[k;x];    else      kadd=[k;zeros(size(x))];    end;    lam=Kadd\kadd;                           % compute the kriging weights lam    lam=lam(1:sumnhlocal);                   % remove the Lagrangians from the solution    lamt=lam';    zk(i)=lamt*zhlocal;                      % compute the kriging estimate zk(i)    K0=coord2K(ck0,ck0,model,param);    vk(i)=K0-2*lamt*k+lamt*K*lam;           % compute the kriging variance vk(i) for covariance  end;  if options(1)==1,    disp([num2str(i),'/',num2strnk]);  end;end;if K0==0,                                   % if needed, correct kriging variances for variogram  vk=-vk;end;