function [zk,Vk]=krigingMP(ck,ch,zh,model,param,order);% krigingMP                 - multi points prediction using kriging (Jan 1,2001)%% Compute the covariance matrix between the estimated kriging values,% instead of merely the vector of estimation variances as in kriging.m.% This covariance matrix is obtained using the Multi-Points (MP)% version of kriging. % % SYNTAX :%% [zk,Vk]=krigingMP(ck,ch,zh,model,param,order);%% INPUT :%% ck        nk by d   matrix of coordinates for the estimation locations.%                     A line corresponds to the vector of coordinates at%                     an estimation location, so the number of columns%                     corresponds to the dimension of the space. There is%                     no restriction on the dimension of the space.% ch        nh by d   matrix of coordinates for the hard data locations,%                     with the same convention as for ck.% zh        nh by 1   vector of values for the hard data at the coordinates%                     specified in ch.% model     string    that contains the name of the variogram or covariance%                     model that is used for the estimation (see the MODELS%                     directory). % param     1 by k    vector of values for the parameters of model, according%                     to the convention for the corresponding variogram or %                     covariance model.% order     scalar    order of the polynomial mean along the spatial axes at%                     the estimation locations. For the zero-mean case, NaN%                     (Not-a-Number) is used. Note that order=NaN can only be%                     used with covariance models and not with variogram models.%% OUTPUT :%% zk        nk by 1   vector of estimated values at the estimation locations. A%                     value coded as NaN means that no estimation has been performed%                     at that location due to the lack of available data. % Vk        nk by nk  covariance matrix between the estimated values at locations%                     specified in ck.%% NOTE :%% All the specific conventions for specifying nested models,% multivariate or space-time cases are the same as for kriging.m.%%%%%% Initialize the parametersnoindex=~iscell(ck);       % test if there is an index for the variablesif noindex==1,  nk=size(ck,1);           % nk is the number of estimation points  nh=size(ch,1);           % nh is the number of hard data valueselse  nk=size(ck{1},1);  nindexk=length(ck{2});  if nindexk==1,    ck{2}=ck{2}*ones(nk,1);  end;  nh=size(ch{1},1);end;zk=zeros(nk,1)*NaN;Vk=zeros(nk,nk)*NaN;k=zeros(nh,nk);%%%%%% Main loop starts hereK=coord2K(ch,ch,model,param);      % built the left-hand side matrixK0=coord2K(ck,ck,model,param);[X,x]=krigconstr(ch,ch,order,'left');nx=size(X,2);Kadd=[[K,X];[X',zeros(nx)]];for i=1:nk,  if noindex==1,    ck0=ck(i,:);  else    ck0={ck{1}(i,:),ck{2}(i)};  end;  k(:,i)=coord2K(ch,ck0,model,param);  [X,x]=krigconstr(ch,ck0,order,'right');  kadd=[k(:,i);x];  lam=Kadd\kadd;  lam=lam(1:nh);  L(:,i)=lam;  zk(i)=lam'*zh;end;L=[eye(nk),-L'];                 % compute the kriging covariance matrixVk=L*[[K0,k'];[k,K]]*L';if K(1,1)==0,                    % if needed, correct kriging variances for variogram  Vk=-Vk;end;